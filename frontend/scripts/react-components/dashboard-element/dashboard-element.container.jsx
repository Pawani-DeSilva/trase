import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';
import React from 'react';
import PropTypes from 'prop-types';
import DashboardElement from 'react-components/dashboard-element/dashboard-element.component';
import { getActiveIndicatorsData } from 'react-components/dashboard-element/dashboard-element.selectors';

const mapStateToProps = state => ({
  indicators: state.dashboardElement.data.indicators,
  activeIndicators: getActiveIndicatorsData(state)
});

const mapDispatchToProps = dispatch =>
  bindActionCreators(
    {
      goToRoot: () => ({ type: 'dashboardRoot' })
    },
    dispatch
  );

let hasVisitedBefore = localStorage.getItem('hasVisitedBefore');

class DashboardElementContainer extends React.Component {
  static propTypes = {
    goToRoot: PropTypes.func.isRequired,
    activeIndicators: PropTypes.array
  };

  state = {
    modalOpen: true,
    goBackOnCloseModal: true,
    step: hasVisitedBefore ? DashboardElement.steps.PANEL : DashboardElement.steps.WELCOME
  };

  componentDidMount() {
    if (!hasVisitedBefore) {
      hasVisitedBefore = true;
      localStorage.setItem('hasVisitedBefore', true);
    }
  }

  closeModal = () => {
    this.setState({ modalOpen: false });
  };

  updateStep = step => this.setState({ step });

  render() {
    const { step, modalOpen, goBackOnCloseModal } = this.state;
    const { goToRoot, activeIndicators } = this.props;
    return (
      <DashboardElement
        step={step}
        goToRoot={goToRoot}
        modalOpen={modalOpen}
        setStep={this.updateStep}
        closeModal={this.closeModal}
        goBackOnCloseModal={goBackOnCloseModal}
        activeIndicators={activeIndicators}
      />
    );
  }
}

export default connect(
  mapStateToProps,
  mapDispatchToProps
)(DashboardElementContainer);
